<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Reality Simulators</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #e8e8e8;
            line-height: 1.6;
        }
        
        #app {
            min-height: 100vh;
        }
        
        .menu {
            max-width: 800px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        
        .title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #64c8ff;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: #808080;
            margin-bottom: 3rem;
        }
        
        .sim-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .sim-btn {
            background: rgba(100, 200, 255, 0.05);
            border: 1px solid rgba(100, 200, 255, 0.2);
            color: #e8e8e8;
            padding: 1rem 1.5rem;
            text-align: left;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .sim-btn:hover {
            background: rgba(100, 200, 255, 0.1);
            border-color: rgba(100, 200, 255, 0.4);
        }
        
        .back-btn {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            background: white;
            color: black;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            z-index: 10000;
        }
        
        .back-btn:hover {
            background: #ddd;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 1.2rem;
            color: #64c8ff;
        }
        
        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 1rem;
            margin: 1rem 0;
        }
        
        #sim-container {
            width: 100%;
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">Loading...</div>
    </div>

    <!-- Load React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>

    <script>
        // Wait for everything to load
        window.addEventListener('load', function() {
            console.log('Starting app...');
            console.log('React:', typeof React);
            console.log('ReactDOM:', typeof ReactDOM);
            console.log('Babel:', typeof Babel);
            
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Babel === 'undefined') {
                document.getElementById('app').innerHTML = '<div class="loading" style="color: #ef4444;">ERROR: Libraries failed to load. Check your internet connection.</div>';
                return;
            }

            // Start the app
            const script = document.createElement('script');
            script.type = 'text/babel';
            script.innerHTML = `
                const { useState, useEffect } = React;

                function App() {
                    const [simulations, setSimulations] = useState([]);
                    const [currentSim, setCurrentSim] = useState(null);
                    const [simCode, setSimCode] = useState('');
                    const [loading, setLoading] = useState(true);
                    const [error, setError] = useState(null);

                    // Load sims.md on mount
                    useEffect(() => {
                        loadSimsList();
                    }, []);

                    async function loadSimsList() {
                        try {
                            const response = await fetch('./sims.md');
                            if (!response.ok) {
                                throw new Error('sims.md not found. Please create it in the same directory.');
                            }
                            
                            const text = await response.text();
                            const lines = text.split('\\n');
                            const sims = [];
                            
                            for (const line of lines) {
                                const trimmed = line.trim();
                                
                                // Skip comments and empty lines
                                if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('//')) {
                                    continue;
                                }
                                
                                // Extract filename
                                let filename = null;
                                
                                // Check for markdown link: [Name](file.tsx)
                                const linkMatch = trimmed.match(/\\[.*?\\]\\((.*?\\.(tsx|jsx))\\)/i);
                                if (linkMatch) {
                                    filename = linkMatch[1];
                                }
                                // Check for list item: - file.tsx or * file.tsx
                                else if (trimmed.match(/^[-*]\\s+/)) {
                                    const listMatch = trimmed.match(/[-*]\\s+(.*?\\.(tsx|jsx))/i);
                                    if (listMatch) {
                                        filename = listMatch[1];
                                    }
                                }
                                // Plain filename
                                else if (trimmed.match(/\\.(tsx|jsx)$/i)) {
                                    filename = trimmed;
                                }
                                
                                if (filename) {
                                    // Remove simulations/ prefix if present
                                    filename = filename.replace(/^simulations\\//, '');
                                    const name = filename.replace(/\\.(tsx|jsx)$/i, '').replace(/_/g, ' ');
                                    sims.push({ filename, name });
                                }
                            }
                            
                            if (sims.length === 0) {
                                throw new Error('No .tsx or .jsx files found in sims.md');
                            }
                            
                            setSimulations(sims);
                            setLoading(false);
                        } catch (err) {
                            console.error('Error loading sims.md:', err);
                            setError(err.message);
                            setLoading(false);
                        }
                    }

                    async function loadSimulation(sim) {
                        setLoading(true);
                        setError(null);
                        
                        try {
                            const response = await fetch('./simulations/' + sim.filename);
                            if (!response.ok) {
                                throw new Error('Could not load ./simulations/' + sim.filename);
                            }
                            
                            const code = await response.text();
                            setSimCode(code);
                            setCurrentSim(sim);
                            setLoading(false);
                        } catch (err) {
                            console.error('Error loading simulation:', err);
                            setError(err.message);
                            setLoading(false);
                        }
                    }

                    function goBack() {
                        setCurrentSim(null);
                        setSimCode('');
                        setError(null);
                    }

                    function SimulationRenderer() {
                        if (!simCode) return null;

                        try {
                            // Strip TypeScript and imports
                            let code = simCode;
                            
                            // Remove imports
                            code = code.replace(/^import\\s+.*?from\\s+['"].*?['"];?\\s*$/gm, '');
                            code = code.replace(/^import\\s+['"].*?['"];?\\s*$/gm, '');
                            
                            // Remove exports
                            code = code.replace(/^export\\s+default\\s+/gm, '');
                            code = code.replace(/^export\\s+/gm, '');
                            
                            // Remove type annotations
                            code = code.replace(/^interface\\s+\\w+\\s*\\{[^}]*\\}/gm, '');
                            code = code.replace(/^type\\s+\\w+\\s*=\\s*[^;]+;/gm, '');
                            code = code.replace(/:\\s*\\w+(\\[\\]|<[^>]+>)?(?=\\s*[=,\\)])/g, '');
                            code = code.replace(/\\):\\s*\\w+(\\[\\]|<[^>]+>)?(?=\\s*[{=>])/g, ')');
                            code = code.replace(/<[A-Z]\\w*(\\s*,\\s*[A-Z]\\w*)*>/g, '');
                            code = code.replace(/\\s+as\\s+\\w+/g, '');
                            
                            // Transform with Babel
                            const transformed = Babel.transform(code, {
                                presets: ['react'],
                                filename: currentSim.filename
                            }).code;
                            
                            // Find component name
                            const match = transformed.match(/(?:function|const|class)\\s+([A-Z]\\w*)/);
                            const componentName = match ? match[1] : 'Component';
                            
                            // Create wrapper function
                            const wrapper = \`
                                (function(React, useState, useEffect, useRef, useMemo, useCallback, useReducer, useContext, Recharts, LucideReact) {
                                    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ReferenceLine, BarChart, Bar, ScatterChart, Scatter } = Recharts || {};
                                    const { Camera, Square, Activity, Play, Pause, RotateCcw, Volume2, VolumeX, ChevronLeft, ChevronRight, Plus, Minus } = LucideReact || {};
                                    
                                    \${transformed}
                                    
                                    return \${componentName};
                                })
                            \`;
                            
                            // Execute
                            const componentFactory = eval(wrapper);
                            const Component = componentFactory(
                                React,
                                React.useState,
                                React.useEffect,
                                React.useRef,
                                React.useMemo,
                                React.useCallback,
                                React.useReducer,
                                React.useContext,
                                window.Recharts,
                                window.lucideReact
                            );
                            
                            return React.createElement(Component);
                        } catch (err) {
                            console.error('Render error:', err);
                            return React.createElement('div', {
                                style: {
                                    padding: '2rem',
                                    background: '#0a0a0a',
                                    color: '#ef4444',
                                    minHeight: '100vh',
                                    fontFamily: 'monospace'
                                }
                            }, [
                                React.createElement('h2', { key: 'h', style: { marginBottom: '1rem' }}, 'Render Error'),
                                React.createElement('div', { key: 'd', style: { background: 'rgba(0,0,0,0.5)', padding: '1rem', marginBottom: '1rem' }}, err.message),
                                React.createElement('pre', { key: 'p', style: { fontSize: '0.8rem', overflow: 'auto', background: 'rgba(0,0,0,0.5)', padding: '1rem' }}, err.stack),
                                React.createElement('button', {
                                    key: 'b',
                                    onClick: goBack,
                                    style: { marginTop: '1rem', padding: '0.5rem 1rem', background: '#ef4444', color: 'white', border: 'none', cursor: 'pointer' }
                                }, '← Back')
                            ]);
                        }
                    }

                    // Render
                    if (currentSim && simCode) {
                        return React.createElement('div', { id: 'sim-container' }, [
                            React.createElement('button', {
                                key: 'back',
                                className: 'back-btn',
                                onClick: goBack
                            }, '← BACK'),
                            React.createElement(SimulationRenderer, { key: 'sim' })
                        ]);
                    }

                    return React.createElement('div', { className: 'menu' }, [
                        React.createElement('h1', { key: 'title', className: 'title' }, 'Fractal Reality Simulators'),
                        React.createElement('p', { key: 'subtitle', className: 'subtitle' }, 'https://github.com/AshmanRoonz/Fractal_Reality'),
                        
                        error && React.createElement('div', { key: 'error', className: 'error' }, error),
                        
                        loading ? 
                            React.createElement('div', { key: 'loading', className: 'loading' }, 'Loading simulations...') :
                            React.createElement('div', { key: 'list', className: 'sim-list' },
                                simulations.map((sim, i) => 
                                    React.createElement('button', {
                                        key: i,
                                        className: 'sim-btn',
                                        onClick: () => loadSimulation(sim)
                                    }, sim.name)
                                )
                            )
                    ]);
                }

                const root = ReactDOM.createRoot(document.getElementById('app'));
                root.render(React.createElement(App));
            `;
            document.body.appendChild(script);
        });
    </script>
</body>
</html>
