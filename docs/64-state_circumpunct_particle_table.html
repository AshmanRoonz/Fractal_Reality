<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⊙ 64-State Circumpunct Viewer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'JetBrains Mono', monospace;
      background: #0a0a0f;
      color: #e0e0e0;
      height: 100vh;
      overflow: hidden;
    }
    
    .app {
      display: grid;
      grid-template-columns: 1fr 320px;
      height: 100vh;
    }
    
    /* Left side - Field viewer */
    .field-panel {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      background: #0a0a0f;
    }
    
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .particle-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .particle-title h2 {
      color: #ffd700;
      font-size: 1rem;
      font-weight: 400;
    }
    
    .particle-title .symbol {
      background: rgba(255,215,0,0.15);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: #ffd700;
      font-size: 0.9rem;
    }
    
    .particle-title .id-badge {
      background: #222;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      color: #888;
      font-size: 0.7rem;
    }
    
    .field-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.6rem;
      color: #666;
    }
    
    .field-stats span { color: #d4a54a; }
    
    .canvas-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    
    .canvas-wrap {
      position: relative;
    }
    
    #canvas {
      border-radius: 8px;
      background: #000;
    }
    
    .overlay {
      position: absolute;
      padding: 0.2rem 0.5rem;
      background: rgba(0,0,0,0.8);
      border-radius: 3px;
      font-size: 0.5rem;
    }
    
    .overlay.tl { top: 8px; left: 8px; color: #d4a54a; }
    .overlay.tr { top: 8px; right: 8px; color: #666; }
    .overlay.bl { bottom: 8px; left: 8px; color: #888; }
    
    .field-controls {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
    }
    
    .ctrl-btn {
      padding: 0.4rem 0.8rem;
      font-family: inherit;
      font-size: 0.55rem;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .ctrl-btn:hover { background: #252525; color: #aaa; }
    .ctrl-btn.active { background: #d4a54a; color: #000; border-color: #d4a54a; }
    .ctrl-btn.running { background: #a44; color: #fff; border-color: #a44; }
    
    .view-btns {
      display: flex;
      gap: 0.25rem;
    }
    
    .properties-bar {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.5rem;
      padding: 0.5rem;
      background: #111;
      border-radius: 6px;
    }
    
    .prop {
      text-align: center;
      padding: 0.3rem;
      background: #0a0a0a;
      border-radius: 4px;
    }
    
    .prop-label { font-size: 0.45rem; color: #555; margin-bottom: 0.15rem; }
    .prop-value { font-size: 0.65rem; color: #d4a54a; }
    .prop-value.fermion { color: #63b3ed; }
    .prop-value.gauge { color: #fc8181; }
    .prop-value.higgs { color: #f6e05e; }
    
    /* Right side - Particle grid */
    .grid-panel {
      background: #111;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .grid-header {
      padding: 0.75rem;
      border-bottom: 1px solid #1a1a1a;
      text-align: center;
    }
    
    .grid-header h1 {
      font-size: 0.9rem;
      color: #ffd700;
      font-weight: 400;
      margin-bottom: 0.25rem;
    }
    
    .grid-header .subtitle {
      font-size: 0.5rem;
      color: #666;
    }
    
    .grid-header .intro {
      font-size: 0.45rem;
      color: #555;
      margin-top: 0.4rem;
      line-height: 1.4;
      padding: 0 0.5rem;
    }
    
    .grid-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    
    .particle-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      padding: 4px;
    }
    
    .cell {
      aspect-ratio: 1;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      min-height: 34px;
      position: relative;
      background: #0a0a0a;
    }
    
    /* Outer ring = sector color */
    .cell::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 3px solid #444;
      transition: all 0.15s;
    }
    
    .cell.fermion::before { border-color: #4299e1; }
    .cell.gauge::before { border-color: #e53e3e; }
    .cell.higgs::before { border-color: #d69e2e; }
    
    /* Inner dot = color charge */
    .cell::after {
      content: '';
      position: absolute;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      top: 2px;
      right: 2px;
    }
    
    /* Color charges for quarks */
    .cell.color-r::after { background: #ff4444; box-shadow: 0 0 3px #ff4444; }
    .cell.color-g::after { background: #44ff44; box-shadow: 0 0 3px #44ff44; }
    .cell.color-b::after { background: #4488ff; box-shadow: 0 0 3px #4488ff; }
    
    /* Leptons - neutral */
    .cell.color-none::after { background: #666; }
    
    /* Gluons - bicolor */
    .cell.color-gluon::after { background: conic-gradient(#ff4444 0deg, #44ff44 120deg, #4488ff 240deg, #ff4444 360deg); }
    
    /* Weak bosons */
    .cell.color-weak::after { background: #ff8844; }
    
    /* Higgs */
    .cell.color-higgs::after { background: #ffd700; box-shadow: 0 0 4px #ffd700; }
    
    .cell:hover { 
      transform: scale(1.25); 
      z-index: 10;
    }
    
    .cell.selected { transform: scale(1.1); }
    .cell.selected::before { 
      border-color: #ffd700 !important; 
      border-width: 4px;
      box-shadow: 0 0 15px rgba(255,215,0,0.9);
    }
    
    /* Generation = ring thickness */
    .cell.gen-1::before { border-width: 2px; }
    .cell.gen-2::before { border-width: 3px; }
    .cell.gen-3::before { border-width: 4px; }
    
    .cell-id { 
      font-size: 0.5rem; 
      font-weight: bold; 
      color: #aaa;
      z-index: 1;
    }
    
    .cell-sym { 
      font-size: 0.38rem; 
      color: #777;
      z-index: 1;
    }
    
    .cell-sym sub {
      font-size: 0.28rem;
      color: #555;
    }
    
    .cell:hover .cell-id { color: #fff; }
    .cell:hover .cell-sym { color: #aaa; }
    
    .view-legend {
      padding: 0.4rem;
      text-align: center;
      font-size: 0.45rem;
      color: #555;
      border-top: 1px solid #1a1a1a;
    }
    
    .view-legend span {
      cursor: help;
    }
    
    .grid-legend {
      padding: 0.4rem;
      border-top: 1px solid #1a1a1a;
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      font-size: 0.5rem;
      color: #888;
    }
    
    .color-legend {
      padding: 0.3rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.45rem;
      color: #666;
      border-top: 1px solid #1a1a1a;
    }
    
    .color-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }
    
    .legend-dot.fermion { background: #3182ce; }
    .legend-dot.gauge { background: #e53e3e; }
    .legend-dot.higgs { background: #d69e2e; }
    
    .tooltip {
      position: fixed;
      background: rgba(10, 10, 20, 0.98);
      border: 1px solid #333;
      border-radius: 6px;
      padding: 0.6rem;
      max-width: 260px;
      z-index: 1000;
      pointer-events: none;
      display: none;
      font-size: 0.55rem;
    }
    
    .tooltip h5 { color: #ffd700; margin-bottom: 0.3rem; font-size: 0.6rem; }
    .tooltip p { color: #aaa; margin: 0.1rem 0; }
  </style>
</head>
<body>
  <div class="app">
    <div class="field-panel">
      <div class="field-header">
        <div class="particle-title">
          <span class="id-badge" id="p-id">0</span>
          <h2 id="p-name">Left Up (Red)</h2>
          <span class="symbol" id="p-sym">u_L^r</span>
        </div>
        <div class="field-stats">
          <span title="Simulation step">Cycle: <span id="cycle">0</span></span> · 
          <span title="Fractal dimension of field support (1=point, 2=fills space, 1.5=balanced)" style="cursor:help">D<sub>Φ</sub>: <span id="dim">1.500</span></span> · 
          <span id="fps">0</span> fps
          <canvas id="d-spark" width="60" height="16" title="D history" style="margin-left:0.5rem;vertical-align:middle;background:#111;border-radius:2px;"></canvas>
        </div>
      </div>
      
      <div class="canvas-area">
        <div class="canvas-wrap">
          <canvas id="canvas" width="400" height="400"></canvas>
          <div class="overlay tl" id="struct" title="Field topology type">—</div>
          <div class="overlay tr" id="vort" title="Phase winding number (vorticity)">ν: 0.0</div>
          <div class="overlay bl" id="energy" title="Energy conservation (should stay ~100%)">E: 100%</div>
        </div>
      </div>
      
      <div class="field-controls">
        <button class="ctrl-btn" id="btn-run">▶ RUN</button>
        <button class="ctrl-btn" id="btn-step">STEP</button>
        <button class="ctrl-btn" id="btn-reset">RESET</button>
        <div class="view-btns">
          <button class="ctrl-btn active" data-v="mag">|Φ|</button>
          <button class="ctrl-btn" data-v="phase">Phase</button>
          <button class="ctrl-btn" data-v="re">Re</button>
          <button class="ctrl-btn" data-v="im">Im</button>
        </div>
      </div>
      
      <div class="properties-bar">
        <div class="prop">
          <div class="prop-label">SECTOR</div>
          <div class="prop-value fermion" id="prop-sector">Fermion</div>
        </div>
        <div class="prop">
          <div class="prop-label">TYPE</div>
          <div class="prop-value" id="prop-type">Quark</div>
        </div>
        <div class="prop">
          <div class="prop-label">GEN</div>
          <div class="prop-value" id="prop-gen">1</div>
        </div>
        <div class="prop">
          <div class="prop-label">SPIN</div>
          <div class="prop-value" id="prop-spin">½</div>
        </div>
        <div class="prop">
          <div class="prop-label">CHARGE</div>
          <div class="prop-value" id="prop-q">+⅔</div>
        </div>
        <div class="prop">
          <div class="prop-label">MASS</div>
          <div class="prop-value" id="prop-mass">2.2 MeV</div>
        </div>
      </div>
    </div>
    
    <div class="grid-panel">
      <div class="grid-header">
        <h1>⊙ 64-State Universe</h1>
        <div class="subtitle">Standard Model as field configurations</div>
        <div class="intro">Standard Model in the <b>electroweak basis</b> (before symmetry breaking). The photon γ and Z⁰ emerge from W³+B mixing after SSB. Hover for details including masses.</div>
      </div>
      <div class="grid-scroll">
        <div class="particle-grid" id="grid"></div>
      </div>
      <div class="grid-legend">
        <span style="color:#4299e1">○</span> Fermion
        <span style="color:#e53e3e">○</span> Gauge
        <span style="color:#d69e2e">○</span> Higgs
      </div>
      <div class="color-legend">
        <span class="color-dot" style="background:#ff4444"></span>R
        <span class="color-dot" style="background:#44ff44"></span>G
        <span class="color-dot" style="background:#4488ff"></span>B
        <span style="color:#666;margin-left:0.5rem">· ring = sector · dot = color charge · thickness = generation</span>
      </div>
      <div class="view-legend">
        <span title="Field amplitude - brighter = stronger">|Φ| amplitude</span> · 
        <span title="Phase angle as color wheel">Phase angle</span> · 
        <span title="Real part (red +, blue -)">Re/Im parts</span>
      </div>
    </div>
  </div>
  
  <div class="tooltip" id="tooltip"></div>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// PARTICLE DATA - All 64 Standard Model States
// ═══════════════════════════════════════════════════════════════════════════
const P = {
  // ═══════════════════════════════════════════════════════════════════
  // GENERATION 1 - QUARKS (0-11)
  // ═══════════════════════════════════════════════════════════════════
  0:{n:"Up Quark",s:"u",sub:"L,r",g:1,t:"quark",c:"L",x:"r",S:"Fermion",Q:"+⅔",spin:0.5,mass:"2.2 MeV"},
  1:{n:"Up Quark",s:"u",sub:"L,g",g:1,t:"quark",c:"L",x:"g",S:"Fermion",Q:"+⅔",spin:0.5,mass:"2.2 MeV"},
  2:{n:"Up Quark",s:"u",sub:"L,b",g:1,t:"quark",c:"L",x:"b",S:"Fermion",Q:"+⅔",spin:0.5,mass:"2.2 MeV"},
  3:{n:"Down Quark",s:"d",sub:"L,r",g:1,t:"quark",c:"L",x:"r",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.7 MeV"},
  4:{n:"Down Quark",s:"d",sub:"L,g",g:1,t:"quark",c:"L",x:"g",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.7 MeV"},
  5:{n:"Down Quark",s:"d",sub:"L,b",g:1,t:"quark",c:"L",x:"b",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.7 MeV"},
  6:{n:"Up Quark",s:"u",sub:"R,r",g:1,t:"quark",c:"R",x:"r",S:"Fermion",Q:"+⅔",spin:0.5,mass:"2.2 MeV"},
  7:{n:"Up Quark",s:"u",sub:"R,g",g:1,t:"quark",c:"R",x:"g",S:"Fermion",Q:"+⅔",spin:0.5,mass:"2.2 MeV"},
  8:{n:"Up Quark",s:"u",sub:"R,b",g:1,t:"quark",c:"R",x:"b",S:"Fermion",Q:"+⅔",spin:0.5,mass:"2.2 MeV"},
  9:{n:"Down Quark",s:"d",sub:"R,r",g:1,t:"quark",c:"R",x:"r",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.7 MeV"},
  10:{n:"Down Quark",s:"d",sub:"R,g",g:1,t:"quark",c:"R",x:"g",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.7 MeV"},
  11:{n:"Down Quark",s:"d",sub:"R,b",g:1,t:"quark",c:"R",x:"b",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.7 MeV"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GENERATION 1 - LEPTONS (12-15)
  // ═══════════════════════════════════════════════════════════════════
  12:{n:"Electron Neutrino",s:"νₑ",sub:"L",g:1,t:"lepton",c:"L",S:"Fermion",Q:"0",spin:0.5,mass:"<1 eV"},
  13:{n:"Electron",s:"e",sub:"L",g:1,t:"lepton",c:"L",S:"Fermion",Q:"-1",spin:0.5,mass:"0.511 MeV"},
  14:{n:"Electron",s:"e",sub:"R",g:1,t:"lepton",c:"R",S:"Fermion",Q:"-1",spin:0.5,mass:"0.511 MeV"},
  15:{n:"Electron Neutrino",s:"νₑ",sub:"R",g:1,t:"lepton",c:"R",S:"Fermion",Q:"0",spin:0.5,mass:"<1 eV",note:"Sterile"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GENERATION 2 - QUARKS (16-27)
  // ═══════════════════════════════════════════════════════════════════
  16:{n:"Charm Quark",s:"c",sub:"L,r",g:2,t:"quark",c:"L",x:"r",S:"Fermion",Q:"+⅔",spin:0.5,mass:"1.27 GeV"},
  17:{n:"Charm Quark",s:"c",sub:"L,g",g:2,t:"quark",c:"L",x:"g",S:"Fermion",Q:"+⅔",spin:0.5,mass:"1.27 GeV"},
  18:{n:"Charm Quark",s:"c",sub:"L,b",g:2,t:"quark",c:"L",x:"b",S:"Fermion",Q:"+⅔",spin:0.5,mass:"1.27 GeV"},
  19:{n:"Strange Quark",s:"s",sub:"L,r",g:2,t:"quark",c:"L",x:"r",S:"Fermion",Q:"-⅓",spin:0.5,mass:"95 MeV"},
  20:{n:"Strange Quark",s:"s",sub:"L,g",g:2,t:"quark",c:"L",x:"g",S:"Fermion",Q:"-⅓",spin:0.5,mass:"95 MeV"},
  21:{n:"Strange Quark",s:"s",sub:"L,b",g:2,t:"quark",c:"L",x:"b",S:"Fermion",Q:"-⅓",spin:0.5,mass:"95 MeV"},
  22:{n:"Charm Quark",s:"c",sub:"R,r",g:2,t:"quark",c:"R",x:"r",S:"Fermion",Q:"+⅔",spin:0.5,mass:"1.27 GeV"},
  23:{n:"Charm Quark",s:"c",sub:"R,g",g:2,t:"quark",c:"R",x:"g",S:"Fermion",Q:"+⅔",spin:0.5,mass:"1.27 GeV"},
  24:{n:"Charm Quark",s:"c",sub:"R,b",g:2,t:"quark",c:"R",x:"b",S:"Fermion",Q:"+⅔",spin:0.5,mass:"1.27 GeV"},
  25:{n:"Strange Quark",s:"s",sub:"R,r",g:2,t:"quark",c:"R",x:"r",S:"Fermion",Q:"-⅓",spin:0.5,mass:"95 MeV"},
  26:{n:"Strange Quark",s:"s",sub:"R,g",g:2,t:"quark",c:"R",x:"g",S:"Fermion",Q:"-⅓",spin:0.5,mass:"95 MeV"},
  27:{n:"Strange Quark",s:"s",sub:"R,b",g:2,t:"quark",c:"R",x:"b",S:"Fermion",Q:"-⅓",spin:0.5,mass:"95 MeV"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GENERATION 2 - LEPTONS (28-31)
  // ═══════════════════════════════════════════════════════════════════
  28:{n:"Muon Neutrino",s:"νμ",sub:"L",g:2,t:"lepton",c:"L",S:"Fermion",Q:"0",spin:0.5,mass:"<0.17 MeV"},
  29:{n:"Muon",s:"μ",sub:"L",g:2,t:"lepton",c:"L",S:"Fermion",Q:"-1",spin:0.5,mass:"105.7 MeV"},
  30:{n:"Muon",s:"μ",sub:"R",g:2,t:"lepton",c:"R",S:"Fermion",Q:"-1",spin:0.5,mass:"105.7 MeV"},
  31:{n:"Muon Neutrino",s:"νμ",sub:"R",g:2,t:"lepton",c:"R",S:"Fermion",Q:"0",spin:0.5,mass:"<0.17 MeV",note:"Sterile"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GENERATION 3 - QUARKS (32-43)
  // ═══════════════════════════════════════════════════════════════════
  32:{n:"Top Quark",s:"t",sub:"L,r",g:3,t:"quark",c:"L",x:"r",S:"Fermion",Q:"+⅔",spin:0.5,mass:"173 GeV"},
  33:{n:"Top Quark",s:"t",sub:"L,g",g:3,t:"quark",c:"L",x:"g",S:"Fermion",Q:"+⅔",spin:0.5,mass:"173 GeV"},
  34:{n:"Top Quark",s:"t",sub:"L,b",g:3,t:"quark",c:"L",x:"b",S:"Fermion",Q:"+⅔",spin:0.5,mass:"173 GeV"},
  35:{n:"Bottom Quark",s:"b",sub:"L,r",g:3,t:"quark",c:"L",x:"r",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.18 GeV"},
  36:{n:"Bottom Quark",s:"b",sub:"L,g",g:3,t:"quark",c:"L",x:"g",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.18 GeV"},
  37:{n:"Bottom Quark",s:"b",sub:"L,b",g:3,t:"quark",c:"L",x:"b",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.18 GeV"},
  38:{n:"Top Quark",s:"t",sub:"R,r",g:3,t:"quark",c:"R",x:"r",S:"Fermion",Q:"+⅔",spin:0.5,mass:"173 GeV"},
  39:{n:"Top Quark",s:"t",sub:"R,g",g:3,t:"quark",c:"R",x:"g",S:"Fermion",Q:"+⅔",spin:0.5,mass:"173 GeV"},
  40:{n:"Top Quark",s:"t",sub:"R,b",g:3,t:"quark",c:"R",x:"b",S:"Fermion",Q:"+⅔",spin:0.5,mass:"173 GeV"},
  41:{n:"Bottom Quark",s:"b",sub:"R,r",g:3,t:"quark",c:"R",x:"r",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.18 GeV"},
  42:{n:"Bottom Quark",s:"b",sub:"R,g",g:3,t:"quark",c:"R",x:"g",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.18 GeV"},
  43:{n:"Bottom Quark",s:"b",sub:"R,b",g:3,t:"quark",c:"R",x:"b",S:"Fermion",Q:"-⅓",spin:0.5,mass:"4.18 GeV"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GENERATION 3 - LEPTONS (44-47)
  // ═══════════════════════════════════════════════════════════════════
  44:{n:"Tau Neutrino",s:"ντ",sub:"L",g:3,t:"lepton",c:"L",S:"Fermion",Q:"0",spin:0.5,mass:"<18.2 MeV"},
  45:{n:"Tau",s:"τ",sub:"L",g:3,t:"lepton",c:"L",S:"Fermion",Q:"-1",spin:0.5,mass:"1.777 GeV"},
  46:{n:"Tau",s:"τ",sub:"R",g:3,t:"lepton",c:"R",S:"Fermion",Q:"-1",spin:0.5,mass:"1.777 GeV"},
  47:{n:"Tau Neutrino",s:"ντ",sub:"R",g:3,t:"lepton",c:"R",S:"Fermion",Q:"0",spin:0.5,mass:"<18.2 MeV",note:"Sterile"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GAUGE BOSONS - GLUONS (48-55) - SU(3) color
  // ═══════════════════════════════════════════════════════════════════
  48:{n:"Gluon",s:"g",sub:"1",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"rḡ + gr̄"},
  49:{n:"Gluon",s:"g",sub:"2",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"-i(rḡ - gr̄)"},
  50:{n:"Gluon",s:"g",sub:"3",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"rr̄ - gḡ"},
  51:{n:"Gluon",s:"g",sub:"4",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"rb̄ + br̄"},
  52:{n:"Gluon",s:"g",sub:"5",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"-i(rb̄ - br̄)"},
  53:{n:"Gluon",s:"g",sub:"6",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"gḇ + bḡ"},
  54:{n:"Gluon",s:"g",sub:"7",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"-i(gḇ - bḡ)"},
  55:{n:"Gluon",s:"g",sub:"8",g:null,t:"gluon",S:"Gauge",Q:"0",spin:1,mass:"0",note:"(rr̄+gḡ-2bḇ)/√3"},
  
  // ═══════════════════════════════════════════════════════════════════
  // GAUGE BOSONS - ELECTROWEAK (56-59) - SU(2)×U(1)
  // ═══════════════════════════════════════════════════════════════════
  56:{n:"W Boson",s:"W",sub:"1",g:null,t:"weak",S:"Gauge",Q:"±1",spin:1,mass:"80.4 GeV",ssb:"→ W⁺",note:"SU(2)"},
  57:{n:"W Boson",s:"W",sub:"2",g:null,t:"weak",S:"Gauge",Q:"±1",spin:1,mass:"80.4 GeV",ssb:"→ W⁻",note:"SU(2)"},
  58:{n:"W Boson / Z / Photon",s:"W",sub:"3",g:null,t:"weak",S:"Gauge",Q:"0",spin:1,mass:"—",ssb:"→ Z⁰, γ",note:"Mixes with B"},
  59:{n:"B Boson / Z / Photon",s:"B",sub:"",g:null,t:"hypercharge",S:"Gauge",Q:"0",spin:1,mass:"—",ssb:"→ Z⁰, γ",note:"U(1), mixes with W³"},
  
  // ═══════════════════════════════════════════════════════════════════
  // HIGGS DOUBLET (60-63)
  // ═══════════════════════════════════════════════════════════════════
  60:{n:"Higgs (charged)",s:"H",sub:"+",g:null,t:"higgs",S:"Higgs",Q:"+1",spin:0,mass:"—",ssb:"→ G⁺ (eaten by W⁺)",note:"Goldstone"},
  61:{n:"Higgs (charged)",s:"H",sub:"-",g:null,t:"higgs",S:"Higgs",Q:"-1",spin:0,mass:"—",ssb:"→ G⁻ (eaten by W⁻)",note:"Goldstone"},
  62:{n:"Higgs Boson",s:"H",sub:"0",g:null,t:"higgs",S:"Higgs",Q:"0",spin:0,mass:"125.1 GeV",ssb:"Physical Higgs",note:"Discovered 2012"},
  63:{n:"Higgs (vacuum)",s:"H",sub:"v",g:null,t:"higgs",S:"Higgs",Q:"0",spin:0,mass:"—",ssb:"→ G⁰ (eaten by Z)",special:"⊙ v = 246 GeV"}
};

// ═══════════════════════════════════════════════════════════════════════════
// CIRCUMPUNCT FIELD - Adapted for particle visualization
// ═══════════════════════════════════════════════════════════════════════════
class Field {
  constructor(n=80) {
    this.n = n;
    this.f = new Float32Array(n*n*2);
    this.t = new Float32Array(n*n*2);
    this.cycle = 0;
    this.e0 = 1;
    this.conv = 0.5;
    this.theta = 10*Math.PI/180;
    this.emerg = 0.5;
    this.dHistory = []; // Track fractal dimension over time
  }
  
  i(x,y) { return (((y%this.n)+this.n)%this.n*this.n + ((x%this.n)+this.n)%this.n)*2; }
  re(x,y) { return this.f[this.i(x,y)]; }
  im(x,y) { return this.f[this.i(x,y)+1]; }
  mag(x,y) { const r=this.re(x,y),i=this.im(x,y); return Math.sqrt(r*r+i*i); }
  phase(x,y) { return Math.atan2(this.im(x,y),this.re(x,y)); }
  
  // Initialize based on particle properties
  initParticle(p) {
    const cx=this.n/2, cy=this.n/2;
    const spin = p.spin || 0;
    const gen = p.g || 1;
    const isQuark = p.t === 'quark';
    const isLepton = p.t === 'lepton';
    const isGauge = p.S === 'Gauge';
    const isHiggs = p.S === 'Higgs';
    const isLeft = p.c === 'L';
    const isGluon = p.t === 'gluon';
    
    // Color charge determines 3-fold symmetry for quarks
    let colorPhase = 0;
    if (p.x === 'r') colorPhase = 0;
    else if (p.x === 'g') colorPhase = 2*Math.PI/3;
    else if (p.x === 'b') colorPhase = 4*Math.PI/3;
    
    // Generation affects scale (higher gen = tighter localization)
    const scale = this.n / (3 + gen);
    
    // Chirality affects rotation direction
    const chiralSign = isLeft ? 1 : -1;
    
    for(let y=0;y<this.n;y++) for(let x=0;x<this.n;x++) {
      const dx=x-cx, dy=y-cy;
      const r=Math.sqrt(dx*dx+dy*dy);
      const th=Math.atan2(dy,dx);
      
      let amp=0, phase=0;
      
      if(isHiggs) {
        // Higgs: scalar field, circumpunct pattern
        // H_v (vacuum) is special - the ground state
        if(p.sub === 'v') {
          // Vacuum/eternal - pure circumpunct ⊙
          const iR=this.n/8, oR=this.n/3;
          amp = 3*Math.exp(-r*r/(2*iR*iR)) + Math.exp(-Math.pow(r-oR,2)/(2*Math.pow(oR/6,2)));
          phase = 0; // Real, no phase
        } else if(p.sub === '0') {
          // Physical Higgs boson (125 GeV)
          const w = this.n/4;
          amp = 2.5*Math.exp(-r*r/(2*w*w));
          phase = 0;
        } else {
          // Charged Higgs / Goldstones
          const w = this.n/4;
          amp = 2*Math.exp(-r*r/(2*w*w));
          phase = (p.sub === '+') ? th : -th;
        }
      }
      else if(isGauge) {
        // Gauge bosons: spin-1 vortices
        const w = this.n/3;
        
        if(p.t === 'gluon') {
          // Gluons: 8 patterns based on Gell-Mann matrices
          const gluonNum = parseInt(p.sub) || 1;
          amp = Math.pow(r/w, 1) * Math.exp(-r*r/(2*w*w)) * 2;
          phase = th + (gluonNum-1)*Math.PI/4;
        }
        else if(p.t === 'weak') {
          // W bosons: SU(2) structure
          amp = Math.pow(r/w, 1) * Math.exp(-r*r/(2*w*w)) * 2;
          phase = th * (p.sub === '3' ? 2 : 1);
        }
        else {
          // B boson
          amp = Math.pow(r/w, 1) * Math.exp(-r*r/(2*w*w)) * 2;
          phase = th;
        }
      }
      else if(isQuark) {
        // Quarks: spin-1/2 with color structure
        // 3-fold color symmetry visible in pattern
        const vortexCharge = 0.5 * chiralSign;
        amp = Math.pow(r/scale, Math.abs(vortexCharge)) * Math.exp(-r*r/(2*scale*scale)) * 2;
        
        // Phase includes vortex + color + generation modulation
        phase = th * vortexCharge + colorPhase + Math.cos(3*th)*0.3/gen;
      }
      else if(isLepton) {
        // Leptons: spin-1/2, no color (simpler)
        const vortexCharge = 0.5 * chiralSign;
        amp = Math.pow(r/scale, Math.abs(vortexCharge)) * Math.exp(-r*r/(2*scale*scale)) * 2.5;
        
        // Neutrinos are more diffuse
        if(p.t === 'lepton' && p.Q === '0') {
          amp *= 0.7;
          amp += 0.3*Math.exp(-r*r/(2*(this.n/2)*(this.n/2)));
        }
        
        phase = th * vortexCharge;
      }
      
      const idx = this.i(x,y);
      this.f[idx] = amp * Math.cos(phase);
      this.f[idx+1] = amp * Math.sin(phase);
    }
    
    this.cycle = 0;
    this.e0 = this.energy();
    this.dHistory = [this.fractalD()]; // Reset history
    
    // Set dynamics based on particle
    this.theta = (isLeft ? 1 : -1) * (5 + 5*spin) * Math.PI/180;
  }
  
  step() {
    // Convergence
    const c = this.conv * 0.25;
    for(let y=0;y<this.n;y++) for(let x=0;x<this.n;x++) {
      const oR=this.re(x,y), oI=this.im(x,y);
      const aR=(oR+this.re(x+1,y)+this.re(x-1,y)+this.re(x,y+1)+this.re(x,y-1))/5;
      const aI=(oI+this.im(x+1,y)+this.im(x-1,y)+this.im(x,y+1)+this.im(x,y-1))/5;
      const idx=this.i(x,y);
      this.t[idx]=(1-c)*oR+c*aR;
      this.t[idx+1]=(1-c)*oI+c*aI;
    }
    this.f.set(this.t);
    
    // Rotation
    const cos=Math.cos(this.theta), sin=Math.sin(this.theta);
    for(let i=0;i<this.f.length;i+=2) {
      const r=this.f[i], im=this.f[i+1];
      this.f[i]=r*cos-im*sin;
      this.f[i+1]=r*sin+im*cos;
    }
    
    // Emergence
    const e = this.emerg * 0.12;
    for(let y=0;y<this.n;y++) for(let x=0;x<this.n;x++) {
      const cR=this.re(x,y), cI=this.im(x,y);
      const lR=this.re(x+1,y)+this.re(x-1,y)+this.re(x,y+1)+this.re(x,y-1)-4*cR;
      const lI=this.im(x+1,y)+this.im(x-1,y)+this.im(x,y+1)+this.im(x,y-1)-4*cI;
      const idx=this.i(x,y);
      this.t[idx]=cR-e*lR;
      this.t[idx+1]=cI-e*lI;
    }
    this.f.set(this.t);
    
    // Normalize
    const en=this.energy();
    if(en>1e-10) { const s=Math.sqrt(this.e0/en); for(let i=0;i<this.f.length;i++) this.f[i]*=s; }
    
    this.cycle++;
    
    // Track D every few cycles
    if(this.cycle % 3 === 0) {
      this.dHistory.push(this.fractalD());
      if(this.dHistory.length > 100) this.dHistory.shift();
    }
  }
  
  energy() { let e=0; for(let i=0;i<this.f.length;i+=2) e+=this.f[i]*this.f[i]+this.f[i+1]*this.f[i+1]; return e; }
  maxMag() { let m=0; for(let i=0;i<this.f.length;i+=2) { const v=this.f[i]*this.f[i]+this.f[i+1]*this.f[i+1]; if(v>m)m=v; } return Math.sqrt(m); }
  
  vorticity() {
    const cx=this.n/2, cy=this.n/2, rad=this.n/4, steps=32;
    let v=0, pp=null;
    for(let i=0;i<=steps;i++) {
      const a=(i/steps)*2*Math.PI;
      const p=this.phase(Math.round(cx+rad*Math.cos(a)), Math.round(cy+rad*Math.sin(a)));
      if(pp!==null) { let d=p-pp; while(d>Math.PI)d-=2*Math.PI; while(d<-Math.PI)d+=2*Math.PI; v+=d; }
      pp=p;
    }
    return v/(2*Math.PI);
  }
  
  fractalD() {
    const avg=this.energy()/(this.n*this.n), th=avg*0.25, scales=[2,4,8,16], pts=[];
    for(const sc of scales) {
      let cnt=0; const cs=this.n/sc;
      for(let cy=0;cy<sc;cy++) for(let cx=0;cx<sc;cx++) {
        let has=false;
        for(let y=Math.floor(cy*cs);y<Math.floor((cy+1)*cs)&&!has;y++)
          for(let x=Math.floor(cx*cs);x<Math.floor((cx+1)*cs)&&!has;x++) {
            const idx=this.i(x,y);
            if(this.f[idx]*this.f[idx]+this.f[idx+1]*this.f[idx+1]>th) has=true;
          }
        if(has) cnt++;
      }
      if(cnt>0) pts.push({s:sc,c:cnt});
    }
    if(pts.length<2) return 2;
    let sx=0,sy=0,sxy=0,sx2=0;
    for(const{s,c}of pts) { const x=Math.log(s),y=Math.log(c); sx+=x;sy+=y;sxy+=x*y;sx2+=x*x; }
    return Math.max(1,Math.min(2,(pts.length*sxy-sx*sy)/(pts.length*sx2-sx*sx)));
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// APP
// ═══════════════════════════════════════════════════════════════════════════
class App {
  constructor() {
    this.field = new Field(80);
    this.particleId = 0;
    this.running = false;
    this.view = 'mag';
    this.lastT = 0;
    this.frames = 0;
    
    this.canvas = document.getElementById('canvas');
    this.ctx = this.canvas.getContext('2d');
    this.img = this.ctx.createImageData(this.canvas.width, this.canvas.height);
    
    this.sparkCanvas = document.getElementById('d-spark');
    this.sparkCtx = this.sparkCanvas.getContext('2d');
    
    this.tooltip = document.getElementById('tooltip');
    
    this.buildGrid();
    this.bind();
    this.selectParticle(0);
  }
  
  buildGrid() {
    const grid = document.getElementById('grid');
    for(let id=0; id<64; id++) {
      const p = P[id];
      const cell = document.createElement('div');
      
      // Base sector class
      cell.className = 'cell ' + p.S.toLowerCase();
      
      // Generation class (affects border thickness)
      if(p.g) cell.classList.add('gen-' + p.g);
      
      // Color charge class (affects inner dot)
      if(p.x === 'r') cell.classList.add('color-r');
      else if(p.x === 'g') cell.classList.add('color-g');
      else if(p.x === 'b') cell.classList.add('color-b');
      else if(p.t === 'lepton') cell.classList.add('color-none');
      else if(p.t === 'gluon') cell.classList.add('color-gluon');
      else if(p.t === 'weak' || p.t === 'hypercharge') cell.classList.add('color-weak');
      else if(p.t === 'higgs') cell.classList.add('color-higgs');
      
      cell.innerHTML = `<span class="cell-id">${id}</span><span class="cell-sym">${p.s}<sub>${p.sub||''}</sub></span>`;
      cell.onclick = () => this.selectParticle(id);
      cell.onmouseenter = (e) => this.showTooltip(e, id);
      cell.onmousemove = (e) => this.moveTooltip(e);
      cell.onmouseleave = () => this.tooltip.style.display = 'none';
      cell.dataset.id = id;
      grid.appendChild(cell);
    }
  }
  
  showTooltip(e, id) {
    const p = P[id];
    let h = `<h5>${p.n}</h5>`;
    h += `<p><b>Symbol:</b> ${p.s}${p.sub ? '<sub>'+p.sub+'</sub>' : ''}</p>`;
    h += `<p><b>Sector:</b> ${p.S} · <b>Spin:</b> ${p.spin}</p>`;
    h += `<p><b>Charge:</b> ${p.Q}</p>`;
    if(p.mass) h += `<p><b>Mass:</b> ${p.mass}</p>`;
    if(p.g) h += `<p><b>Generation:</b> ${p.g}</p>`;
    if(p.c) h += `<p><b>Chirality:</b> ${p.c === 'L' ? 'Left-handed' : 'Right-handed'}</p>`;
    if(p.x) h += `<p><b>Color:</b> ${p.x === 'r' ? 'Red' : p.x === 'g' ? 'Green' : 'Blue'}</p>`;
    if(p.ssb) h += `<p style="color:#ffa"><b>After SSB:</b> ${p.ssb}</p>`;
    if(p.note) h += `<p style="color:#aaf"><b>Note:</b> ${p.note}</p>`;
    if(p.special) h += `<p style="color:#ffd700"><b>★ ${p.special}</b></p>`;
    this.tooltip.innerHTML = h;
    this.tooltip.style.display = 'block';
    this.moveTooltip(e);
  }
  
  moveTooltip(e) {
    let x = e.clientX + 10, y = e.clientY + 10;
    if(x + 200 > window.innerWidth) x = e.clientX - 210;
    if(y + 150 > window.innerHeight) y = e.clientY - 150;
    this.tooltip.style.left = x + 'px';
    this.tooltip.style.top = y + 'px';
  }
  
  selectParticle(id) {
    this.particleId = id;
    const p = P[id];
    
    // Stop current simulation
    this.running = false;
    
    // Update selection
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
    document.querySelector(`.cell[data-id="${id}"]`).classList.add('selected');
    
    // Update header
    document.getElementById('p-id').textContent = id;
    document.getElementById('p-name').textContent = p.n;
    document.getElementById('p-sym').innerHTML = p.s + (p.sub ? '<sub>'+p.sub+'</sub>' : '');
    
    // Update properties
    const sectorEl = document.getElementById('prop-sector');
    sectorEl.textContent = p.S;
    sectorEl.className = 'prop-value ' + p.S.toLowerCase();
    
    document.getElementById('prop-type').textContent = p.t.charAt(0).toUpperCase() + p.t.slice(1);
    document.getElementById('prop-gen').textContent = p.g || '—';
    document.getElementById('prop-spin').textContent = p.spin === 0.5 ? '½' : p.spin === 1 ? '1' : '0';
    document.getElementById('prop-q').textContent = p.Q;
    document.getElementById('prop-mass').textContent = p.mass || '—';
    
    // Initialize field
    this.field.initParticle(p);
    this.render();
    
    // Auto-run
    this.running = true;
    document.getElementById('btn-run').textContent = '■ STOP';
    document.getElementById('btn-run').classList.add('running');
    this.lastT = performance.now();
    this.frames = 0;
    this.animate();
  }
  
  bind() {
    document.getElementById('btn-run').onclick = () => {
      this.running = !this.running;
      const btn = document.getElementById('btn-run');
      btn.textContent = this.running ? '■ STOP' : '▶ RUN';
      btn.classList.toggle('running', this.running);
      if(this.running) { this.lastT = performance.now(); this.frames = 0; this.animate(); }
    };
    
    document.getElementById('btn-step').onclick = () => {
      if(!this.running) { this.field.step(); this.render(); }
    };
    
    document.getElementById('btn-reset').onclick = () => {
      this.running = false;
      document.getElementById('btn-run').textContent = '▶ RUN';
      document.getElementById('btn-run').classList.remove('running');
      this.field.initParticle(P[this.particleId]);
      this.render();
      // Don't auto-run on reset - let user step through manually if desired
    };
    
    document.querySelectorAll('.view-btns .ctrl-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.view-btns .ctrl-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.view = btn.dataset.v;
        this.render();
      };
    });
  }
  
  animate() {
    if(!this.running) return;
    this.field.step();
    this.frames++;
    
    const now = performance.now();
    if(now - this.lastT >= 500) {
      document.getElementById('fps').textContent = Math.round(this.frames*1000/(now-this.lastT));
      this.frames = 0;
      this.lastT = now;
    }
    
    this.render();
    requestAnimationFrame(() => this.animate());
  }
  
  render() {
    const n = this.field.n;
    const scale = this.canvas.width / n;
    const data = this.img.data;
    
    let maxM = this.field.maxMag() || 1;
    let maxR = 0, maxI = 0;
    for(let i=0;i<this.field.f.length;i+=2) {
      maxR = Math.max(maxR, Math.abs(this.field.f[i]));
      maxI = Math.max(maxI, Math.abs(this.field.f[i+1]));
    }
    
    // Get particle color for theming
    const p = P[this.particleId];
    let baseHue = 0.12; // gold
    if(p.S === 'Fermion') baseHue = 0.6; // blue
    if(p.S === 'Gauge') baseHue = 0.0; // red
    if(p.S === 'Higgs') baseHue = 0.12; // gold
    
    for(let y=0;y<n;y++) for(let x=0;x<n;x++) {
      const idx = this.field.i(x,y);
      const re = this.field.f[idx], im = this.field.f[idx+1];
      const mag = Math.sqrt(re*re+im*im);
      const phase = Math.atan2(im, re);
      
      let r,g,b;
      if(this.view==='mag') {
        const v = Math.pow(mag/maxM, 0.7);
        // Color based on particle type
        if(p.S === 'Fermion') {
          r = 40*v*v|0; g = 150*v|0; b = 255*v|0;
        } else if(p.S === 'Gauge') {
          r = 255*v|0; g = 80*v|0; b = 80*v*v|0;
        } else {
          r = 255*v|0; g = 200*v|0; b = 50*v*v|0;
        }
      } else if(this.view==='phase') {
        const h = (phase+Math.PI)/(2*Math.PI);
        const l = 0.1 + 0.75*(mag/maxM);
        [r,g,b] = this.hsl(h, 0.9, l);
      } else if(this.view==='re') {
        const v = re/(maxR||1);
        r = v>0 ? 220*v|0 : 0;
        b = v<0 ? 220*(-v)|0 : 0;
        g = 30;
      } else {
        const v = im/(maxI||1);
        g = v>0 ? 220*v|0 : 0;
        r = v<0 ? 180*(-v)|0 : 0;
        b = 30;
      }
      
      for(let py=0;py<scale;py++) for(let px=0;px<scale;px++) {
        const pi = ((y*scale+py)*this.canvas.width + (x*scale+px))*4;
        data[pi]=r; data[pi+1]=g; data[pi+2]=b; data[pi+3]=255;
      }
    }
    
    this.ctx.putImageData(this.img, 0, 0);
    
    // Update stats
    document.getElementById('cycle').textContent = this.field.cycle;
    document.getElementById('dim').textContent = this.field.fractalD().toFixed(3);
    document.getElementById('vort').textContent = 'ν: ' + this.field.vorticity().toFixed(2);
    document.getElementById('energy').textContent = 'E: ' + ((this.field.energy()/this.field.e0)*100).toFixed(0) + '%';
    
    // Structure detection - based on particle type and field topology
    const v = Math.abs(this.field.vorticity());
    let struct = '—';
    
    if(p.S === 'Higgs') {
      struct = v < 0.15 ? 'scalar' : 'excited';
    } else if(p.S === 'Gauge') {
      struct = v > 0.8 ? 'vortex-1' : 'gauge';
    } else { // Fermion
      if(Math.abs(v - 0.5) < 0.15) struct = 'spinor';
      else if(v > 0.3) struct = 'vortex';
      else struct = 'localized';
    }
    document.getElementById('struct').textContent = struct;
    
    // Render D sparkline
    this.renderSparkline();
  }
  
  renderSparkline() {
    const ctx = this.sparkCtx;
    const w = this.sparkCanvas.width;
    const h = this.sparkCanvas.height;
    const data = this.field.dHistory;
    
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, w, h);
    
    if(data.length < 2) return;
    
    // Draw target line at D=1.5
    const ty = h - ((1.5 - 1) / 1) * h;
    ctx.strokeStyle = '#5af';
    ctx.setLineDash([1, 1]);
    ctx.beginPath();
    ctx.moveTo(0, ty);
    ctx.lineTo(w, ty);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Draw D history
    ctx.strokeStyle = '#d4a54a';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i = 0; i < data.length; i++) {
      const x = (i / (data.length - 1)) * w;
      const y = h - ((data[i] - 1) / 1) * h; // D ranges 1-2
      if(i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }
  
  hsl(h,s,l) {
    const f = (n) => {
      const k = (n + h*12) % 12;
      const a = s * Math.min(l, 1-l);
      return l - a * Math.max(-1, Math.min(k-3, 9-k, 1));
    };
    return [f(0)*255|0, f(8)*255|0, f(4)*255|0];
  }
}

new App();
</script>
</body>
</html>
