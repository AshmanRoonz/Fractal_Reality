<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âŠ™ Musical Periodic Table v6 - Fibonacci + 7-Note Scale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0a0a0f; font-family: system-ui, -apple-system, sans-serif; }
        .element-card { transition: all 0.2s ease; }
        .element-card:hover { transform: scale(1.08); z-index: 10; }
        .element-card.selected { transform: scale(1.12); box-shadow: 0 0 0 3px #f39c12; z-index: 20; }
        .element-card.in-chord { box-shadow: 0 0 0 2px #3498db; }
        .playing { animation: pulse 0.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .same-note { outline: 2px dashed rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef } = React;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THE DUAL-LAYER MODEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 
        // Frequency = Base Ã— F(period) Ã— NoteRatio(group)
        //
        // MACRO (Fibonacci): How octaves scale between periods
        // MICRO (7-note):    How elements resolve within a period
        //
        // Fibonacci governs growth; the scale governs completion.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Fibonacci sequence (macro scaling between periods)
        const FIB = [0, 1, 1, 2, 3, 5, 8, 13, 21, 34];
        
        // Period â†’ Fibonacci index mapping
        const PERIOD_TO_FIB = {
            1: 1,  // F(1) = 1
            2: 2,  // F(2) = 1
            3: 3,  // F(3) = 2
            4: 4,  // F(4) = 3
            5: 5,  // F(5) = 5
            6: 6,  // F(6) = 8
            7: 7,  // F(7) = 13
        };

        // The 7 notes of the scale (micro resolution within period)
        const NOTES = ['do', 're', 'mi', 'fa', 'so', 'la', 'ti'];
        
        // Just Intonation ratios - contain Fibonacci numbers (2, 3, 5)!
        const NOTE_RATIOS = {
            'do': 1,        // 1/1 - unison (start)
            're': 9/8,      // 9/8 - major second
            'mi': 5/4,      // 5/4 - major third (Fib: 5)
            'fa': 4/3,      // 4/3 - perfect fourth
            'so': 3/2,      // 3/2 - perfect fifth (Fib: 3, 2)
            'la': 5/3,      // 5/3 - major sixth (Fib: 5, 3)
            'ti': 15/8,     // 15/8 - major seventh (15 = 3Ã—5)
            'DO': 2,        // 2/1 - octave (completion)
        };

        // Note colors
        const NOTE_COLORS = {
            'do': '#e74c3c',  // red - root
            're': '#e67e22',  // orange
            'mi': '#f1c40f',  // yellow
            'fa': '#2ecc71',  // green
            'so': '#3498db',  // blue
            'la': '#9b59b6',  // purple
            'ti': '#e91e63',  // pink - leading tone
            'DO': '#c0392b',  // dark red - completion
        };

        // Group â†’ Note mapping (main group elements)
        const GROUP_TO_NOTE = {
            1: 'do',   // Alkali - START
            2: 're',   // Alkaline earth
            13: 'mi',  // Boron group
            14: 'fa',  // Carbon group
            15: 'so',  // Nitrogen group (pnictogens)
            16: 'la',  // Oxygen group (chalcogens)
            17: 'ti',  // Halogens - LEADING TONE
            18: 'DO',  // Noble gases - COMPLETION
        };

        // Transition metals: chromatic fill between re and ti
        // Groups 3-12 interpolate
        const TRANSITION_NOTE_RATIOS = {
            3:  10/9,   // between do and re
            4:  9/8,    // re
            5:  6/5,    // minor third
            6:  5/4,    // mi (major third)
            7:  4/3,    // fa
            8:  45/32,  // tritone
            9:  3/2,    // so
            10: 8/5,    // minor sixth
            11: 5/3,    // la
            12: 16/9,   // minor seventh (approaching ti)
        };

        // Base frequency (middle C)
        const BASE_FREQ = 256;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THE FORMULA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 
        // Frequency = Base Ã— F(period) Ã— NoteRatio(group)
        //
        // This means:
        // - Same group, different periods = SAME NOTE, Fibonacci-scaled
        // - Same period, different groups = SAME SCALE, moving toward completion
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const getFrequency = (period, group, isTransition = false, fBlockIndex = null) => {
            const fibIndex = PERIOD_TO_FIB[period] || 1;
            const fibMultiplier = FIB[fibIndex];
            
            let noteRatio;
            
            if (fBlockIndex !== null) {
                // f-block: microtonal between do and re
                noteRatio = 1 + (fBlockIndex / 14) * (9/8 - 1);
            } else if (isTransition) {
                noteRatio = TRANSITION_NOTE_RATIOS[group] || 1;
            } else {
                const note = GROUP_TO_NOTE[group];
                noteRatio = NOTE_RATIOS[note] || 1;
            }
            
            return BASE_FREQ * fibMultiplier * noteRatio;
        };

        const getNote = (group, isTransition = false) => {
            if (isTransition) {
                // Map transition groups to approximate notes
                const transitionNotes = {
                    3: 'do+', 4: 're', 5: 're+', 6: 'mi',
                    7: 'fa', 8: 'fa+', 9: 'so', 10: 'la-',
                    11: 'la', 12: 'ti-'
                };
                return transitionNotes[group] || '?';
            }
            return GROUP_TO_NOTE[group] || '?';
        };

        // Format frequency
        const formatFreq = (freq) => {
            if (freq >= 1000) return `${(freq/1000).toFixed(2)} kHz`;
            return `${freq.toFixed(1)} Hz`;
        };

        // Get musical note name
        const getMusicalNoteName = (freq) => {
            const A4 = 440;
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const semitones = 12 * Math.log2(freq / A4);
            const noteIndex = Math.round(semitones) + 9;
            const octave = Math.floor((noteIndex + 3) / 12) + 4;
            const noteName = noteNames[((noteIndex % 12) + 12) % 12];
            return `â‰ˆ${noteName}${octave}`;
        };

        // Element data
        const elements = [
            // Period 1
            { Z: 1, symbol: 'H', name: 'Hydrogen', row: 1, col: 1, group: 1, period: 1 },
            { Z: 2, symbol: 'He', name: 'Helium', row: 1, col: 18, group: 18, period: 1 },
            // Period 2
            { Z: 3, symbol: 'Li', name: 'Lithium', row: 2, col: 1, group: 1, period: 2 },
            { Z: 4, symbol: 'Be', name: 'Beryllium', row: 2, col: 2, group: 2, period: 2 },
            { Z: 5, symbol: 'B', name: 'Boron', row: 2, col: 13, group: 13, period: 2 },
            { Z: 6, symbol: 'C', name: 'Carbon', row: 2, col: 14, group: 14, period: 2 },
            { Z: 7, symbol: 'N', name: 'Nitrogen', row: 2, col: 15, group: 15, period: 2 },
            { Z: 8, symbol: 'O', name: 'Oxygen', row: 2, col: 16, group: 16, period: 2 },
            { Z: 9, symbol: 'F', name: 'Fluorine', row: 2, col: 17, group: 17, period: 2 },
            { Z: 10, symbol: 'Ne', name: 'Neon', row: 2, col: 18, group: 18, period: 2 },
            // Period 3
            { Z: 11, symbol: 'Na', name: 'Sodium', row: 3, col: 1, group: 1, period: 3 },
            { Z: 12, symbol: 'Mg', name: 'Magnesium', row: 3, col: 2, group: 2, period: 3 },
            { Z: 13, symbol: 'Al', name: 'Aluminum', row: 3, col: 13, group: 13, period: 3 },
            { Z: 14, symbol: 'Si', name: 'Silicon', row: 3, col: 14, group: 14, period: 3 },
            { Z: 15, symbol: 'P', name: 'Phosphorus', row: 3, col: 15, group: 15, period: 3 },
            { Z: 16, symbol: 'S', name: 'Sulfur', row: 3, col: 16, group: 16, period: 3 },
            { Z: 17, symbol: 'Cl', name: 'Chlorine', row: 3, col: 17, group: 17, period: 3 },
            { Z: 18, symbol: 'Ar', name: 'Argon', row: 3, col: 18, group: 18, period: 3 },
            // Period 4
            { Z: 19, symbol: 'K', name: 'Potassium', row: 4, col: 1, group: 1, period: 4 },
            { Z: 20, symbol: 'Ca', name: 'Calcium', row: 4, col: 2, group: 2, period: 4 },
            { Z: 21, symbol: 'Sc', name: 'Scandium', row: 4, col: 3, group: 3, period: 4, transition: true },
            { Z: 22, symbol: 'Ti', name: 'Titanium', row: 4, col: 4, group: 4, period: 4, transition: true },
            { Z: 23, symbol: 'V', name: 'Vanadium', row: 4, col: 5, group: 5, period: 4, transition: true },
            { Z: 24, symbol: 'Cr', name: 'Chromium', row: 4, col: 6, group: 6, period: 4, transition: true },
            { Z: 25, symbol: 'Mn', name: 'Manganese', row: 4, col: 7, group: 7, period: 4, transition: true },
            { Z: 26, symbol: 'Fe', name: 'Iron', row: 4, col: 8, group: 8, period: 4, transition: true },
            { Z: 27, symbol: 'Co', name: 'Cobalt', row: 4, col: 9, group: 9, period: 4, transition: true },
            { Z: 28, symbol: 'Ni', name: 'Nickel', row: 4, col: 10, group: 10, period: 4, transition: true },
            { Z: 29, symbol: 'Cu', name: 'Copper', row: 4, col: 11, group: 11, period: 4, transition: true },
            { Z: 30, symbol: 'Zn', name: 'Zinc', row: 4, col: 12, group: 12, period: 4, transition: true },
            { Z: 31, symbol: 'Ga', name: 'Gallium', row: 4, col: 13, group: 13, period: 4 },
            { Z: 32, symbol: 'Ge', name: 'Germanium', row: 4, col: 14, group: 14, period: 4 },
            { Z: 33, symbol: 'As', name: 'Arsenic', row: 4, col: 15, group: 15, period: 4 },
            { Z: 34, symbol: 'Se', name: 'Selenium', row: 4, col: 16, group: 16, period: 4 },
            { Z: 35, symbol: 'Br', name: 'Bromine', row: 4, col: 17, group: 17, period: 4 },
            { Z: 36, symbol: 'Kr', name: 'Krypton', row: 4, col: 18, group: 18, period: 4 },
            // Period 5
            { Z: 37, symbol: 'Rb', name: 'Rubidium', row: 5, col: 1, group: 1, period: 5 },
            { Z: 38, symbol: 'Sr', name: 'Strontium', row: 5, col: 2, group: 2, period: 5 },
            { Z: 39, symbol: 'Y', name: 'Yttrium', row: 5, col: 3, group: 3, period: 5, transition: true },
            { Z: 40, symbol: 'Zr', name: 'Zirconium', row: 5, col: 4, group: 4, period: 5, transition: true },
            { Z: 41, symbol: 'Nb', name: 'Niobium', row: 5, col: 5, group: 5, period: 5, transition: true },
            { Z: 42, symbol: 'Mo', name: 'Molybdenum', row: 5, col: 6, group: 6, period: 5, transition: true },
            { Z: 43, symbol: 'Tc', name: 'Technetium', row: 5, col: 7, group: 7, period: 5, transition: true },
            { Z: 44, symbol: 'Ru', name: 'Ruthenium', row: 5, col: 8, group: 8, period: 5, transition: true },
            { Z: 45, symbol: 'Rh', name: 'Rhodium', row: 5, col: 9, group: 9, period: 5, transition: true },
            { Z: 46, symbol: 'Pd', name: 'Palladium', row: 5, col: 10, group: 10, period: 5, transition: true },
            { Z: 47, symbol: 'Ag', name: 'Silver', row: 5, col: 11, group: 11, period: 5, transition: true },
            { Z: 48, symbol: 'Cd', name: 'Cadmium', row: 5, col: 12, group: 12, period: 5, transition: true },
            { Z: 49, symbol: 'In', name: 'Indium', row: 5, col: 13, group: 13, period: 5 },
            { Z: 50, symbol: 'Sn', name: 'Tin', row: 5, col: 14, group: 14, period: 5 },
            { Z: 51, symbol: 'Sb', name: 'Antimony', row: 5, col: 15, group: 15, period: 5 },
            { Z: 52, symbol: 'Te', name: 'Tellurium', row: 5, col: 16, group: 16, period: 5 },
            { Z: 53, symbol: 'I', name: 'Iodine', row: 5, col: 17, group: 17, period: 5 },
            { Z: 54, symbol: 'Xe', name: 'Xenon', row: 5, col: 18, group: 18, period: 5 },
            // Period 6
            { Z: 55, symbol: 'Cs', name: 'Cesium', row: 6, col: 1, group: 1, period: 6 },
            { Z: 56, symbol: 'Ba', name: 'Barium', row: 6, col: 2, group: 2, period: 6 },
            { Z: 57, symbol: 'La', name: 'Lanthanum', row: 6, col: 3, group: 3, period: 6, transition: true },
            // Lanthanides (f-block)
            { Z: 58, symbol: 'Ce', name: 'Cerium', row: 8, col: 4, period: 6, fBlock: true, fIndex: 1 },
            { Z: 59, symbol: 'Pr', name: 'Praseodymium', row: 8, col: 5, period: 6, fBlock: true, fIndex: 2 },
            { Z: 60, symbol: 'Nd', name: 'Neodymium', row: 8, col: 6, period: 6, fBlock: true, fIndex: 3 },
            { Z: 61, symbol: 'Pm', name: 'Promethium', row: 8, col: 7, period: 6, fBlock: true, fIndex: 4 },
            { Z: 62, symbol: 'Sm', name: 'Samarium', row: 8, col: 8, period: 6, fBlock: true, fIndex: 5 },
            { Z: 63, symbol: 'Eu', name: 'Europium', row: 8, col: 9, period: 6, fBlock: true, fIndex: 6 },
            { Z: 64, symbol: 'Gd', name: 'Gadolinium', row: 8, col: 10, period: 6, fBlock: true, fIndex: 7 },
            { Z: 65, symbol: 'Tb', name: 'Terbium', row: 8, col: 11, period: 6, fBlock: true, fIndex: 8 },
            { Z: 66, symbol: 'Dy', name: 'Dysprosium', row: 8, col: 12, period: 6, fBlock: true, fIndex: 9 },
            { Z: 67, symbol: 'Ho', name: 'Holmium', row: 8, col: 13, period: 6, fBlock: true, fIndex: 10 },
            { Z: 68, symbol: 'Er', name: 'Erbium', row: 8, col: 14, period: 6, fBlock: true, fIndex: 11 },
            { Z: 69, symbol: 'Tm', name: 'Thulium', row: 8, col: 15, period: 6, fBlock: true, fIndex: 12 },
            { Z: 70, symbol: 'Yb', name: 'Ytterbium', row: 8, col: 16, period: 6, fBlock: true, fIndex: 13 },
            { Z: 71, symbol: 'Lu', name: 'Lutetium', row: 8, col: 17, period: 6, fBlock: true, fIndex: 14 },
            // Period 6 continued
            { Z: 72, symbol: 'Hf', name: 'Hafnium', row: 6, col: 4, group: 4, period: 6, transition: true },
            { Z: 73, symbol: 'Ta', name: 'Tantalum', row: 6, col: 5, group: 5, period: 6, transition: true },
            { Z: 74, symbol: 'W', name: 'Tungsten', row: 6, col: 6, group: 6, period: 6, transition: true },
            { Z: 75, symbol: 'Re', name: 'Rhenium', row: 6, col: 7, group: 7, period: 6, transition: true },
            { Z: 76, symbol: 'Os', name: 'Osmium', row: 6, col: 8, group: 8, period: 6, transition: true },
            { Z: 77, symbol: 'Ir', name: 'Iridium', row: 6, col: 9, group: 9, period: 6, transition: true },
            { Z: 78, symbol: 'Pt', name: 'Platinum', row: 6, col: 10, group: 10, period: 6, transition: true },
            { Z: 79, symbol: 'Au', name: 'Gold', row: 6, col: 11, group: 11, period: 6, transition: true },
            { Z: 80, symbol: 'Hg', name: 'Mercury', row: 6, col: 12, group: 12, period: 6, transition: true },
            { Z: 81, symbol: 'Tl', name: 'Thallium', row: 6, col: 13, group: 13, period: 6 },
            { Z: 82, symbol: 'Pb', name: 'Lead', row: 6, col: 14, group: 14, period: 6 },
            { Z: 83, symbol: 'Bi', name: 'Bismuth', row: 6, col: 15, group: 15, period: 6 },
            { Z: 84, symbol: 'Po', name: 'Polonium', row: 6, col: 16, group: 16, period: 6 },
            { Z: 85, symbol: 'At', name: 'Astatine', row: 6, col: 17, group: 17, period: 6 },
            { Z: 86, symbol: 'Rn', name: 'Radon', row: 6, col: 18, group: 18, period: 6 },
        ];

        // Audio synth
        const useAudioSynth = () => {
            const audioCtxRef = useRef(null);
            const oscillatorsRef = useRef({});
            const gainNodesRef = useRef({});

            const initAudio = () => {
                if (!audioCtxRef.current) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioCtxRef.current;
            };

            const playTone = (id, frequency) => {
                const ctx = initAudio();
                stopTone(id);

                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, ctx.currentTime);
                
                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.12, ctx.currentTime + 0.05);
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                oscillator.start();
                
                oscillatorsRef.current[id] = oscillator;
                gainNodesRef.current[id] = gainNode;
            };

            const stopTone = (id) => {
                if (oscillatorsRef.current[id]) {
                    const ctx = audioCtxRef.current;
                    const gainNode = gainNodesRef.current[id];
                    if (gainNode && ctx) {
                        gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
                    }
                    setTimeout(() => {
                        if (oscillatorsRef.current[id]) {
                            try { oscillatorsRef.current[id].stop(); } catch(e) {}
                            delete oscillatorsRef.current[id];
                            delete gainNodesRef.current[id];
                        }
                    }, 150);
                }
            };

            const playChord = (frequencies, duration = 2000) => {
                frequencies.forEach((freq, i) => playTone(`chord-${i}`, freq));
                setTimeout(() => {
                    frequencies.forEach((_, i) => stopTone(`chord-${i}`));
                }, duration);
            };

            const playColumn = (group, elements) => {
                // Play same note across all periods (Fibonacci scaling)
                const columnElements = elements.filter(e => e.group === group && !e.fBlock && !e.transition);
                columnElements.forEach((el, i) => {
                    setTimeout(() => {
                        const freq = getFrequency(el.period, el.group);
                        playTone(`col-${i}`, freq);
                        setTimeout(() => stopTone(`col-${i}`), 400);
                    }, i * 300);
                });
            };

            const playRow = (period, elements) => {
                // Play scale across one period
                const rowElements = elements
                    .filter(e => e.period === period && !e.fBlock)
                    .sort((a, b) => a.col - b.col);
                rowElements.forEach((el, i) => {
                    setTimeout(() => {
                        const freq = getFrequency(el.period, el.group, el.transition);
                        playTone(`row-${i}`, freq);
                        setTimeout(() => stopTone(`row-${i}`), 250);
                    }, i * 200);
                });
            };

            return { playTone, stopTone, playChord, playColumn, playRow, initAudio };
        };

        // Element Card
        const ElementCard = ({ element, isSelected, isInChord, onClick, onRightClick, viewMode, highlightGroup }) => {
            const freq = getFrequency(
                element.period, 
                element.group, 
                element.transition,
                element.fBlock ? element.fIndex : null
            );
            
            const note = element.fBlock ? 'doâ†’re' : getNote(element.group, element.transition);
            const baseNote = GROUP_TO_NOTE[element.group] || (element.transition ? 'chromatic' : '?');
            
            let bgColor;
            if (viewMode === 'note') {
                bgColor = NOTE_COLORS[baseNote] || '#4a5568';
                if (element.transition) bgColor = NOTE_COLORS[baseNote] ? NOTE_COLORS[baseNote] + 'bb' : '#4a5568';
                if (element.fBlock) bgColor = '#2d3748';
            } else if (viewMode === 'period') {
                const hue = (element.period * 45) % 360;
                bgColor = `hsl(${hue}, 60%, 40%)`;
            } else if (viewMode === 'fibonacci') {
                const fibVal = FIB[PERIOD_TO_FIB[element.period]] || 1;
                const hue = (Math.log2(fibVal) * 60) % 360;
                bgColor = `hsl(${hue}, 70%, 45%)`;
            }

            const isSameGroup = highlightGroup && element.group === highlightGroup && !element.fBlock && !element.transition;

            return (
                <div 
                    className={`element-card cursor-pointer rounded-lg p-1 text-center relative 
                        ${isSelected ? 'selected' : ''} 
                        ${isInChord ? 'in-chord' : ''}
                        ${isSameGroup ? 'same-note' : ''}`}
                    style={{ 
                        backgroundColor: bgColor,
                        gridColumn: element.col,
                        gridRow: element.row,
                        minWidth: '48px'
                    }}
                    onClick={() => onClick(element)}
                    onContextMenu={(e) => { e.preventDefault(); onRightClick(element); }}
                    title={`${element.name}\n${note} Â· Period ${element.period}\nF(${PERIOD_TO_FIB[element.period]})=${FIB[PERIOD_TO_FIB[element.period]]}\n${formatFreq(freq)}`}
                >
                    <div className="text-white">
                        <div className="text-xs opacity-70">{element.Z}</div>
                        <div className="text-base font-bold">{element.symbol}</div>
                        <div className="text-xs opacity-80">{note}</div>
                    </div>
                    {element.group === 18 && !element.fBlock && (
                        <div className="absolute top-0 right-0 text-xs">âœ“</div>
                    )}
                    {isInChord && (
                        <div className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full text-xs flex items-center justify-center">â™ª</div>
                    )}
                </div>
            );
        };

        // Info Panel
        const InfoPanel = ({ element, onPlayTone, onPlayColumn, onPlayRow, elements }) => {
            if (!element) return (
                <div className="bg-gray-800 rounded-xl p-4 text-gray-400 text-center">
                    <div className="text-4xl mb-2">âŠ™</div>
                    <p className="font-bold">Dual-Layer Model</p>
                    <p className="text-xs mt-2">Fibonacci Ã— 7-Note Scale</p>
                    <p className="text-xs mt-1">f = Base Ã— F(period) Ã— Note(group)</p>
                </div>
            );

            const freq = getFrequency(
                element.period, 
                element.group, 
                element.transition,
                element.fBlock ? element.fIndex : null
            );
            const note = element.fBlock ? 'doâ†’re' : getNote(element.group, element.transition);
            const fibIndex = PERIOD_TO_FIB[element.period];
            const fibValue = FIB[fibIndex];
            const noteRatio = element.fBlock 
                ? (1 + (element.fIndex / 14) * (9/8 - 1)).toFixed(4)
                : (element.transition 
                    ? TRANSITION_NOTE_RATIOS[element.group]?.toFixed(4) 
                    : NOTE_RATIOS[GROUP_TO_NOTE[element.group]]?.toFixed(4)) || '?';

            return (
                <div className="bg-gray-800 rounded-xl p-4 text-white">
                    <div className="flex items-center gap-3 mb-3">
                        <div className="w-14 h-14 rounded-lg flex items-center justify-center text-2xl font-bold"
                             style={{ backgroundColor: NOTE_COLORS[GROUP_TO_NOTE[element.group]] || '#4a5568' }}>
                            {element.symbol}
                        </div>
                        <div>
                            <div className="text-lg font-bold">{element.name}</div>
                            <div className="text-sm text-gray-400">Z = {element.Z}</div>
                        </div>
                    </div>

                    {/* The Formula */}
                    <div className="bg-gray-900 rounded p-3 mb-3 font-mono text-sm">
                        <div className="text-gray-400 text-xs mb-1">THE FORMULA</div>
                        <div className="text-yellow-400">
                            {BASE_FREQ} Ã— <span className="text-green-400">{fibValue}</span> Ã— <span className="text-blue-400">{noteRatio}</span> = <span className="text-white">{freq.toFixed(1)}</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                            Base Ã— F({fibIndex}) Ã— {note}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-2 mb-3">
                        <div className="bg-gray-700 rounded p-2">
                            <div className="text-gray-400 text-xs">Period (Fibonacci)</div>
                            <div className="text-green-400 font-mono">
                                P{element.period} â†’ F({fibIndex}) = {fibValue}
                            </div>
                        </div>
                        <div className="bg-gray-700 rounded p-2">
                            <div className="text-gray-400 text-xs">Group (Note)</div>
                            <div className="font-bold" style={{ color: NOTE_COLORS[GROUP_TO_NOTE[element.group]] || '#fff' }}>
                                {note.toUpperCase()} ({noteRatio})
                            </div>
                        </div>
                    </div>

                    <div className="bg-gray-700 rounded p-2 mb-3">
                        <div className="text-gray-400 text-xs">Frequency</div>
                        <div className="text-xl font-mono text-white">{formatFreq(freq)}</div>
                        <div className="text-xs text-gray-400">{getMusicalNoteName(freq)}</div>
                    </div>

                    <div className="grid grid-cols-3 gap-2">
                        <button 
                            onClick={() => onPlayTone(element)}
                            className="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm"
                        >
                            ðŸ”Š Play
                        </button>
                        <button 
                            onClick={() => onPlayColumn(element.group, elements)}
                            className="bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm"
                            title="Same note across periods (Fibonacci scaling)"
                        >
                            â†• Column
                        </button>
                        <button 
                            onClick={() => onPlayRow(element.period, elements)}
                            className="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded text-sm"
                            title="Scale across period (7-note resolution)"
                        >
                            â†” Period
                        </button>
                    </div>
                </div>
            );
        };

        // Chord Builder
        const ChordBuilder = ({ chordElements, onRemove, onClear, onPlayChord }) => {
            const frequencies = chordElements.map(el => 
                getFrequency(el.period, el.group, el.transition, el.fBlock ? el.fIndex : null)
            );

            const getMoleculeFormula = () => {
                const counts = {};
                chordElements.forEach(el => {
                    counts[el.symbol] = (counts[el.symbol] || 0) + 1;
                });
                return Object.entries(counts)
                    .map(([sym, count]) => count > 1 ? `${sym}${count}` : sym)
                    .join('');
            };

            return (
                <div className="bg-gray-800 rounded-xl p-4 text-white">
                    <div className="flex justify-between items-center mb-3">
                        <div className="font-bold text-yellow-400">ðŸŽµ Molecular Chord</div>
                        {chordElements.length > 0 && (
                            <button onClick={onClear} className="text-xs text-red-400 hover:text-red-300">Clear</button>
                        )}
                    </div>

                    {chordElements.length === 0 ? (
                        <div className="text-gray-400 text-sm text-center py-4">
                            Right-click to add elements
                        </div>
                    ) : (
                        <>
                            <div className="text-2xl font-mono text-center mb-3 text-green-400">
                                {getMoleculeFormula()}
                            </div>
                            
                            <div className="space-y-1 mb-3 max-h-28 overflow-y-auto text-sm">
                                {chordElements.map((el, i) => {
                                    const note = getNote(el.group, el.transition);
                                    return (
                                        <div key={`${el.Z}-${i}`} className="flex justify-between items-center bg-gray-700 rounded px-2 py-1">
                                            <span className="font-bold">{el.symbol}</span>
                                            <span className="text-xs">{note} Â· P{el.period}</span>
                                            <span className="text-xs font-mono">{formatFreq(frequencies[i])}</span>
                                            <button onClick={() => onRemove(i)} className="text-red-400 text-xs">âœ•</button>
                                        </div>
                                    );
                                })}
                            </div>

                            <button 
                                onClick={() => onPlayChord(frequencies)}
                                className="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded"
                            >
                                ðŸŽ¶ Play Chord
                            </button>
                        </>
                    )}
                </div>
            );
        };

        // Dual Layer Explanation
        const DualLayerPanel = () => (
            <div className="bg-gray-800 rounded-xl p-4 text-white text-xs">
                <div className="font-bold text-yellow-400 mb-2">The Dual-Layer Model</div>
                
                <div className="mb-3">
                    <div className="text-green-400 font-bold">FIBONACCI (Macro)</div>
                    <div className="text-gray-400">Period-to-period scaling</div>
                    <div className="font-mono">P1â†’P2â†’P3â†’P4â†’P5â†’P6</div>
                    <div className="font-mono text-green-400">F: 1â†’1â†’2â†’3â†’5â†’8</div>
                </div>
                
                <div className="mb-3">
                    <div className="text-blue-400 font-bold">7-NOTE (Micro)</div>
                    <div className="text-gray-400">Element-to-element resolution</div>
                    <div className="font-mono">doâ†’reâ†’miâ†’faâ†’soâ†’laâ†’tiâ†’DO</div>
                    <div className="text-gray-400">Noble gas = completion</div>
                </div>

                <div className="border-t border-gray-700 pt-2">
                    <div className="text-gray-400">Same group = same note, Fibonacci-scaled</div>
                    <div className="text-gray-400">C, Si, Ge, Sn, Pb all = <span className="text-green-400">fa</span></div>
                </div>
            </div>
        );

        // Harmonic Equivalence Display
        const HarmonicEquivalence = ({ elements, selected }) => {
            if (!selected || selected.fBlock || selected.transition) return null;
            
            const sameGroup = elements.filter(e => 
                e.group === selected.group && !e.fBlock && !e.transition
            );
            
            return (
                <div className="bg-gray-800 rounded-xl p-4 text-white text-xs">
                    <div className="font-bold text-yellow-400 mb-2">Harmonic Equivalents (same note)</div>
                    <div className="space-y-1">
                        {sameGroup.map(el => {
                            const freq = getFrequency(el.period, el.group);
                            const fibVal = FIB[PERIOD_TO_FIB[el.period]];
                            return (
                                <div key={el.Z} className={`flex justify-between ${el.Z === selected.Z ? 'text-yellow-400' : ''}`}>
                                    <span className="font-bold">{el.symbol}</span>
                                    <span>P{el.period} (Ã—{fibVal})</span>
                                    <span className="font-mono">{formatFreq(freq)}</span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [selected, setSelected] = useState(null);
            const [viewMode, setViewMode] = useState('note');
            const [chordElements, setChordElements] = useState([]);
            const [isPlaying, setIsPlaying] = useState(false);
            
            const { playTone, stopTone, playChord, playColumn, playRow, initAudio } = useAudioSynth();

            const handlePlayTone = (element) => {
                initAudio();
                const freq = getFrequency(
                    element.period, 
                    element.group, 
                    element.transition,
                    element.fBlock ? element.fIndex : null
                );
                setIsPlaying(true);
                playTone('single', freq);
                setTimeout(() => {
                    stopTone('single');
                    setIsPlaying(false);
                }, 1500);
            };

            const handlePlayChord = (frequencies) => {
                initAudio();
                setIsPlaying(true);
                playChord(frequencies, 2500);
                setTimeout(() => setIsPlaying(false), 2500);
            };

            const handlePlayColumn = (group) => {
                initAudio();
                setIsPlaying(true);
                playColumn(group, elements);
                setTimeout(() => setIsPlaying(false), 2500);
            };

            const handlePlayRow = (period) => {
                initAudio();
                setIsPlaying(true);
                playRow(period, elements);
                setTimeout(() => setIsPlaying(false), 4000);
            };

            return (
                <div className="min-h-screen p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="text-center mb-4">
                            <h1 className={`text-2xl font-bold text-white mb-1 ${isPlaying ? 'playing' : ''}`}>
                                âŠ™ Musical Periodic Table v6
                            </h1>
                            <p className="text-gray-400 text-sm">
                                <span className="text-green-400">Fibonacci</span> governs octave scaling Â· 
                                <span className="text-blue-400"> 7-note scale</span> governs resolution
                            </p>
                            <p className="text-gray-500 text-xs font-mono">
                                f = {BASE_FREQ} Ã— F(period) Ã— NoteRatio(group)
                            </p>
                        </div>

                        <div className="flex justify-center gap-2 mb-3">
                            {['note', 'period', 'fibonacci'].map(mode => (
                                <button key={mode}
                                    onClick={() => setViewMode(mode)}
                                    className={`px-3 py-1 rounded text-sm capitalize ${
                                        viewMode === mode ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'
                                    }`}>
                                    {mode}
                                </button>
                            ))}
                        </div>

                        <div className="flex gap-4">
                            <div className="flex-1 bg-gray-800 rounded-xl p-3 overflow-x-auto">
                                <div className="grid gap-1" style={{ 
                                    gridTemplateColumns: 'repeat(18, minmax(48px, 1fr))',
                                    gridTemplateRows: 'repeat(8, auto)'
                                }}>
                                    {elements.filter(e => !e.fBlock).map(el => (
                                        <ElementCard 
                                            key={el.Z} 
                                            element={el} 
                                            isSelected={selected?.Z === el.Z}
                                            isInChord={chordElements.some(ce => ce.Z === el.Z)}
                                            onClick={setSelected}
                                            onRightClick={(el) => chordElements.length < 8 && setChordElements([...chordElements, el])}
                                            viewMode={viewMode}
                                            highlightGroup={selected?.group}
                                        />
                                    ))}
                                </div>
                                
                                <div className="mt-3 pt-3 border-t border-gray-700">
                                    <div className="text-gray-400 text-xs mb-2">Lanthanides (microtonal: doâ†’re)</div>
                                    <div className="flex gap-1 flex-wrap">
                                        {elements.filter(e => e.fBlock).map(el => (
                                            <ElementCard 
                                                key={el.Z} 
                                                element={el} 
                                                isSelected={selected?.Z === el.Z}
                                                isInChord={chordElements.some(ce => ce.Z === el.Z)}
                                                onClick={setSelected}
                                                onRightClick={(el) => chordElements.length < 8 && setChordElements([...chordElements, el])}
                                                viewMode={viewMode}
                                                highlightGroup={null}
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="w-72 space-y-3">
                                <InfoPanel 
                                    element={selected} 
                                    onPlayTone={handlePlayTone}
                                    onPlayColumn={handlePlayColumn}
                                    onPlayRow={handlePlayRow}
                                    elements={elements}
                                />
                                <ChordBuilder 
                                    chordElements={chordElements}
                                    onRemove={(i) => setChordElements(chordElements.filter((_, idx) => idx !== i))}
                                    onClear={() => setChordElements([])}
                                    onPlayChord={handlePlayChord}
                                />
                                <HarmonicEquivalence elements={elements} selected={selected} />
                                <DualLayerPanel />
                            </div>
                        </div>

                        <div className="text-center text-gray-500 text-xs mt-4">
                            Column (â†•) = same note, Fibonacci-scaled Â· Row (â†”) = scale resolving to noble gas
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
